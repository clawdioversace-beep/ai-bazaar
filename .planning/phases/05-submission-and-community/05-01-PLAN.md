---
phase: 05-submission-and-community
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/submit/page.tsx
  - src/app/submit/actions.ts
  - src/app/layout.tsx
  - src/services/catalog.ts
autonomous: true

must_haves:
  truths:
    - "A visitor can navigate to /submit from the header nav"
    - "A visitor can submit a tool URL via a web form with no account required"
    - "Submitting a URL that already exists surfaces a deduplicated result (not a duplicate entry)"
    - "After successful submission, the visitor is redirected to the new listing page"
    - "The form works without JavaScript (progressive enhancement)"
  artifacts:
    - path: "src/app/submit/page.tsx"
      provides: "Submission form page with useActionState"
      min_lines: 40
    - path: "src/app/submit/actions.ts"
      provides: "Server Action for form submission with Zod validation and dedup"
      exports: ["submitListing"]
    - path: "src/app/layout.tsx"
      provides: "Updated nav with Submit link"
      contains: "/submit"
    - path: "src/services/catalog.ts"
      provides: "getListingBySourceUrl function for dedup lookup"
      exports: ["getListingBySourceUrl"]
  key_links:
    - from: "src/app/submit/page.tsx"
      to: "src/app/submit/actions.ts"
      via: "useActionState binding to submitListing Server Action"
      pattern: "useActionState.*submitListing"
    - from: "src/app/submit/actions.ts"
      to: "src/services/catalog.ts"
      via: "getListingBySourceUrl for dedup, createListing for insert"
      pattern: "getListingBySourceUrl|createListing"
    - from: "src/app/submit/actions.ts"
      to: "src/lib/catalog-schema.ts"
      via: "Zod schema for URL validation and normalization"
      pattern: "CatalogEntrySchema|createSlug"
---

<objective>
Permissionless tool submission form with URL validation and deduplication.

Purpose: Enables anyone (human or agent) to add a tool to the catalog without an account. Uses Server Actions for progressive enhancement (works without JS). Validates URL with Zod, checks for duplicates via normalized sourceUrl, creates a stub listing, and redirects to the new listing page.

Output: /submit page with form, Server Action with validation + dedup, nav link in header, getListingBySourceUrl helper in CatalogService.
</objective>

<execution_context>
@/Users/clawdioversace/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clawdioversace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/catalog.ts
@src/lib/catalog-schema.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getListingBySourceUrl to CatalogService and create Server Action</name>
  <files>
    src/services/catalog.ts
    src/app/submit/actions.ts
  </files>
  <action>
    **In src/services/catalog.ts:**
    Add a new exported function `getListingBySourceUrl(url: string)` that:
    1. Normalizes the URL using the existing `normalizeSourceUrl` private function
    2. Queries `db.query.listings.findFirst` where `sourceUrl` equals the normalized URL
    3. Returns the listing or undefined
    This enables dedup checks without coupling form logic to URL normalization internals.

    **In src/app/submit/actions.ts (new file):**
    Create a Server Action `submitListing` with signature `(prevState: unknown, formData: FormData)`.

    1. Mark file with `'use server'` directive at top
    2. Define a Zod schema for form validation:
       - `url`: z.string().url() — required
       - `name`: z.string().min(1).max(100).optional() — user can optionally provide a name
       - `description`: z.string().max(500).optional()
    3. Parse formData through the Zod schema using `safeParse`
    4. On validation failure, return `{ errors: validatedFields.error.flatten().fieldErrors }`
    5. On success:
       a. Call `getListingBySourceUrl(url)` to check for duplicates
       b. If duplicate found, return `{ errors: { url: ['This tool is already listed'] }, existingSlug: existing.slug }`
       c. If no duplicate, call `createListing()` with:
          - `sourceUrl: url`
          - `name: name || deriveNameFromUrl(url)` — extract repo name or domain as fallback
          - `slug: createSlug(name || deriveNameFromUrl(url))`
          - `tagline: description || 'Submitted via AI Bazaar'`
          - `description: description || 'This tool was submitted to AI Bazaar and is awaiting enrichment.'`
          - `category: 'framework'` (safe default per Phase 4 decision — enrichment will fix it)
          - `tags: []` (enrichment will populate)
          - `submittedBy: 'web-form'`
       d. Call `redirect('/tools/' + listing.slug)` (from 'next/navigation')
    6. Add a helper `deriveNameFromUrl(url: string): string` that extracts a readable name from a URL:
       - GitHub: "org/repo" → "Repo"
       - npm: "package/name" → "Name"
       - Fallback: hostname without TLD

    **Important:** Use `redirect()` from `next/navigation` — it throws (by design in Next.js), so it must NOT be inside a try/catch block. Call it AFTER the createListing succeeds.
  </action>
  <verify>
    TypeScript compiles: `cd /Users/clawdioversace/ai-bazaar && bunx tsc --noEmit --pretty 2>&1 | head -30`
    Verify exports: `grep -n 'export.*getListingBySourceUrl' src/services/catalog.ts`
    Verify Server Action: `grep -n "'use server'" src/app/submit/actions.ts`
  </verify>
  <done>
    getListingBySourceUrl is exported from CatalogService. submitListing Server Action validates URL, checks dedup, creates listing stub, and redirects. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create submission form page and add nav link</name>
  <files>
    src/app/submit/page.tsx
    src/app/layout.tsx
  </files>
  <action>
    **In src/app/submit/page.tsx (new file):**
    Create the submission form page as a Client Component ('use client') that uses `useActionState` from React for progressive enhancement.

    1. Import `useActionState` from `'react'`
    2. Import `submitListing` from `'./actions'`
    3. Create form with these fields:
       - `url` (required): `<input type="url" name="url" required placeholder="https://github.com/org/repo" />` — full-width text input
       - `name` (optional): `<input type="text" name="name" placeholder="Tool name (auto-detected if blank)" />`
       - `description` (optional): `<textarea name="description" rows={3} placeholder="Brief description (optional)" maxLength={500} />`
    4. Use `useActionState(submitListing, undefined)` to get `[state, action, pending]`
    5. Set form's `action` attribute to the `action` from useActionState
    6. Display validation errors from `state?.errors` below each field (red text, text-sm)
    7. If `state?.existingSlug`, show a link to the existing listing: "This tool is already listed. View it here →"
    8. Submit button: disabled when `pending`, shows "Submitting..." text when pending, "Submit Tool" when idle
    9. Add `export const metadata` with title "Submit a Tool | AI Bazaar"

    **Styling:** Follow existing Tailwind patterns from the codebase:
    - Card-like container with `rounded-lg border border-zinc-200 bg-white p-6 shadow-sm dark:border-zinc-800 dark:bg-zinc-900`
    - Input styling: `w-full rounded-lg border border-zinc-300 px-4 py-2 text-sm focus:border-zinc-500 focus:outline-none focus:ring-1 focus:ring-zinc-500 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100`
    - Submit button: matches hero CTA style from homepage (`rounded-lg bg-zinc-900 px-6 py-3 font-medium text-white hover:bg-zinc-700`)
    - Section heading: `text-3xl font-bold text-zinc-900 dark:text-zinc-50`

    **Note:** Since this is a Client Component, export metadata from a separate `layout.tsx` file in submit/ OR use `generateMetadata` in a parent. Simplest: just set `<title>` in the page head via the page metadata convention. Since Client Components cannot export metadata, add a `src/app/submit/layout.tsx` that exports the metadata, or use a page-level `<title>` tag. The simplest approach: make the page a Server Component wrapper that renders a Client Component form. Create:
    - `src/app/submit/page.tsx` as Server Component that exports metadata and renders `<SubmitForm />`
    - `src/components/submit-form.tsx` as Client Component with the form logic

    **In src/app/layout.tsx:**
    Add a "Submit" link in the header nav between "Browse" and the closing nav tag:
    ```
    <Link href="/submit" className="text-sm font-medium text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-50">
      Submit
    </Link>
    ```
  </action>
  <verify>
    Files exist: `ls src/app/submit/page.tsx src/components/submit-form.tsx src/app/layout.tsx`
    TypeScript compiles: `cd /Users/clawdioversace/ai-bazaar && bunx tsc --noEmit --pretty 2>&1 | head -30`
    Nav link present: `grep -n '/submit' src/app/layout.tsx`
    Dev server renders: `cd /Users/clawdioversace/ai-bazaar && timeout 15 bun run build 2>&1 | tail -10`
  </verify>
  <done>
    /submit page renders a form with URL (required), name (optional), description (optional) fields. Validation errors display inline. Duplicate submissions show link to existing listing. "Submit" link appears in header nav. Next.js build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/clawdioversace/ai-bazaar && bunx tsc --noEmit` — TypeScript compiles clean
2. `bun run build` — Next.js build succeeds
3. Manual: Navigate to /submit, enter a URL, submit → redirects to /tools/[slug]
4. Manual: Submit same URL again → shows "already listed" error with link
5. Header nav shows Home, Browse, Submit links
</verification>

<success_criteria>
- Submission form at /submit accepts URL + optional metadata
- Duplicate URLs are detected and surfaced (not silently duplicated)
- New submissions create a stub listing and redirect to it
- Form works with progressive enhancement (Server Action)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-submission-and-community/05-01-SUMMARY.md`
</output>
