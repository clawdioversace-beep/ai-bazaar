---
phase: 05-submission-and-community
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/feed/route.ts
autonomous: true

must_haves:
  truths:
    - "A JSON feed at /api/feed returns new listings in reverse-chronological order"
    - "The feed follows JSON Feed 1.1 spec with version, title, feed_url, and items array"
    - "Each item has a unique id, url, title, content_text, date_published, and tags"
    - "The feed supports pagination via limit and offset query params"
    - "The response has Content-Type application/feed+json and cache headers"
  artifacts:
    - path: "src/app/api/feed/route.ts"
      provides: "JSON Feed 1.1 Route Handler"
      exports: ["GET"]
      min_lines: 40
  key_links:
    - from: "src/app/api/feed/route.ts"
      to: "src/services/catalog.ts"
      via: "getAllListings for paginated reverse-chronological data"
      pattern: "getAllListings"
---

<objective>
JSON Feed 1.1 endpoint for agent crawlers and power users.

Purpose: Exposes the catalog as a machine-readable feed at a stable URL, enabling agent crawlers and feed readers to discover new listings without scraping HTML. Follows the JSON Feed 1.1 specification for maximum interoperability.

Output: Route Handler at /api/feed serving JSON Feed 1.1 with pagination, cache headers, and proper content type.
</objective>

<execution_context>
@/Users/clawdioversace/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clawdioversace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/catalog.ts
@src/services/search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON Feed Route Handler at /api/feed</name>
  <files>
    src/app/api/feed/route.ts
  </files>
  <action>
    Create a Next.js Route Handler at `src/app/api/feed/route.ts`:

    1. Export an async `GET` function that accepts `NextRequest`
    2. Parse query params:
       - `limit`: integer, default 50, max 100 (clamp with Math.min)
       - `offset`: integer, default 0
    3. Fetch listings using `getAllListings(limit + 1, offset)` from `@/services/catalog`
       - Fetch one extra to determine if there are more pages (`hasMore = results.length > limit`)
       - Slice to `limit` for the actual items
    4. Construct JSON Feed 1.1 response object:
       ```typescript
       {
         version: 'https://jsonfeed.org/version/1.1',
         title: 'AI Bazaar - New Listings',
         home_page_url: baseUrl,
         feed_url: `${baseUrl}/api/feed`,
         description: 'Latest AI, Agent & Web3 tools submitted to AI Bazaar',
         items: items.map(listing => ({
           id: listing.id,
           url: `${baseUrl}/tools/${listing.slug}`,
           title: listing.name,
           content_text: listing.description,
           summary: listing.tagline,
           date_published: listing.createdAt?.toISOString() ?? new Date().toISOString(),
           tags: safeJsonParse(listing.tags, []),
           _ai_bazaar: {
             category: listing.category,
             source_url: listing.sourceUrl,
             stars: listing.stars,
             downloads: listing.downloads,
             mcp_compatible: listing.mcpCompatible,
           },
         })),
       }
       ```
    5. If `hasMore`, add `next_url: \`${baseUrl}/api/feed?limit=${limit}&offset=${offset + limit}\`` to the feed object
    6. Use `process.env.NEXT_PUBLIC_BASE_URL || 'https://aibazaar.dev'` as the `baseUrl`
    7. Add a helper `safeJsonParse(json: string | null, fallback: T): T` to safely parse JSON tags field
    8. Return with `NextResponse.json(feed, { headers })` using:
       - `'Content-Type': 'application/feed+json'`
       - `'Cache-Control': 'public, s-maxage=300, stale-while-revalidate=600'` (5 min cache, 10 min stale)
    9. Wrap the entire handler in try/catch — on error, return 500 with `{ error: 'Internal server error' }`

    **Import pattern:** Use `import { NextRequest, NextResponse } from 'next/server'` and `import { getAllListings } from '@/services/catalog'`.

    **Note on the _ai_bazaar extension field:** JSON Feed 1.1 allows custom extension fields prefixed with underscore. This provides AI Bazaar-specific metadata (category, source URL, stars, MCP compatibility) that agents can use without fetching individual listing pages.

    **Note on getAllListings:** It already returns listings ordered by `createdAt DESC` (newest first), which is exactly what we need for reverse-chronological order. No changes needed to the service.
  </action>
  <verify>
    File exists: `ls src/app/api/feed/route.ts`
    Exports GET: `grep -n 'export.*GET' src/app/api/feed/route.ts`
    JSON Feed version: `grep -n 'jsonfeed.org' src/app/api/feed/route.ts`
    Content-Type header: `grep -n 'application/feed+json' src/app/api/feed/route.ts`
    TypeScript compiles: `cd /Users/clawdioversace/ai-bazaar && bunx tsc --noEmit --pretty 2>&1 | head -30`
    Build succeeds: `cd /Users/clawdioversace/ai-bazaar && timeout 30 bun run build 2>&1 | tail -10`
  </verify>
  <done>
    /api/feed returns valid JSON Feed 1.1 with correct version URL, items in reverse-chronological order, pagination support via limit/offset, proper Content-Type and Cache-Control headers. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/clawdioversace/ai-bazaar && bunx tsc --noEmit` — TypeScript compiles clean
2. `bun run build` — Next.js build succeeds
3. `curl http://localhost:3000/api/feed | jq '.version'` returns "https://jsonfeed.org/version/1.1"
4. `curl http://localhost:3000/api/feed | jq '.items | length'` returns <= 50
5. `curl http://localhost:3000/api/feed?limit=2 | jq '.next_url'` shows pagination URL (if > 2 listings exist)
6. Response headers include Content-Type: application/feed+json
</verification>

<success_criteria>
- /api/feed returns valid JSON Feed 1.1 format
- Items are in reverse-chronological order
- Pagination works with limit and offset params
- Cache headers set for 5-minute CDN caching
- Custom _ai_bazaar extension provides category, source URL, and metrics
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-submission-and-community/05-03-SUMMARY.md`
</output>
