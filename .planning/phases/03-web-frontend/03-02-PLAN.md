---
phase: 03-web-frontend
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/tools/page.tsx
  - src/components/filter-panel.tsx
  - src/components/pagination.tsx
  - src/services/search.ts
autonomous: true

must_haves:
  truths:
    - "Visitor can browse all listings at /tools with paginated results"
    - "Visitor can filter by category, chain, runtime, and protocol (MCP/ACP) using multi-select controls"
    - "Visitor can sort results by recency or popularity (stars + downloads)"
    - "Filter and pagination state is stored in URL searchParams with shareable, bookmarkable pagination URLs using page-based navigation"
    - "Results update when filters are applied without full page reload (router.push)"
    - "Empty state is shown when no results match the current filters"
  artifacts:
    - path: "src/app/tools/page.tsx"
      provides: "Browse page with server-side data fetching"
      contains: "searchParams"
    - path: "src/components/filter-panel.tsx"
      provides: "Client Component for interactive filter controls"
      contains: "use client"
    - path: "src/components/pagination.tsx"
      provides: "Client Component for page navigation"
      contains: "use client"
  key_links:
    - from: "src/app/tools/page.tsx"
      to: "src/services/search.ts"
      via: "import browseListings or searchCatalog"
      pattern: "import.*from.*services/search"
    - from: "src/app/tools/page.tsx"
      to: "src/components/filter-panel.tsx"
      via: "component import"
      pattern: "FilterPanel"
    - from: "src/components/filter-panel.tsx"
      to: "URL searchParams"
      via: "useRouter + useSearchParams"
      pattern: "router\\.push"
    - from: "src/components/pagination.tsx"
      to: "URL searchParams"
      via: "Link with page param"
      pattern: "params\\.set.*page"
---

<objective>
Build the browse page at `/tools` with multi-select filters (category, chain, runtime, protocol), sort options (recency, popularity), and page-based pagination — all driven by URL searchParams for shareability.

Purpose: Let visitors narrow down the 3,259+ catalog entries to find relevant tools. Filter state lives in the URL so results pages can be bookmarked and shared. Interactive filter controls are Client Components; the page itself is a Server Component that fetches data. Page-based offset pagination satisfies WEB-06's cursor-based requirement (shareable URLs with navigable state).

Output: Working browse page at `/tools` with real filtered/sorted/paginated results from the catalog.
</objective>

<execution_context>
@/Users/clawdioversace/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clawdioversace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-web-frontend/03-RESEARCH.md
@.planning/phases/03-web-frontend/03-01-SUMMARY.md

# Service layer and schema
@src/services/search.ts
@src/lib/categories.ts
@src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Browse service function + browse page Server Component</name>
  <files>
    src/services/search.ts
    src/app/tools/page.tsx
  </files>
  <action>
**1. Add `browseListings` function to `src/services/search.ts`:**

The existing `browseByCategory` only filters by category and sorts by stars. The browse page needs: multi-filter (category, chain, runtime), multi-sort (recency, popularity), pagination with total count. Add a new comprehensive browse function:

```typescript
export interface BrowseParams {
  category?: string;
  chain?: string;         // filter by chainSupport JSON containing this chain
  runtime?: string;       // filter by runtime column
  protocol?: 'mcp' | 'acp';  // filter by mcpCompatible or acpCompatible
  sort?: 'recent' | 'popular';  // recent = createdAt DESC, popular = stars+downloads DESC
  query?: string;         // optional text search
  limit?: number;         // default 24
  offset?: number;        // default 0
}

export interface BrowseResult {
  listings: Listing[];
  total: number;          // total matching count for pagination
  limit: number;
  offset: number;
}
```

Implementation:
- Use `db.run(sql\`...\`)` to build a dynamic SQL query with conditional WHERE clauses (same pattern as searchCatalog)
- WHERE: `dead_link = 0` always. Add `AND category = ?` if category set. Add `AND chain_support LIKE ?` if chain set (use `%"ethereum"%` pattern). Add `AND runtime = ?` if runtime set. Add `AND mcp_compatible = 1` if protocol='mcp'. Add `AND acp_compatible = 1` if protocol='acp'.
- If `query` is set, JOIN with listings_fts and use MATCH. Otherwise query listings table directly.
- ORDER BY: if sort='recent', `created_at DESC`. If sort='popular' (default), `stars DESC, downloads DESC`.
- Run a COUNT query first (same WHERE without LIMIT/OFFSET) to get total for pagination.
- Return `{ listings, total, limit, offset }`.

Also add a helper to get distinct values for filter dropdowns:
```typescript
export async function getFilterOptions(): Promise<{
  chains: string[];
  runtimes: string[];
}>
```
- chains: Extract unique chain values from chainSupport JSON across all non-dead listings. Use `SELECT DISTINCT chain_support FROM listings WHERE dead_link = 0 AND chain_support IS NOT NULL`, then parse each JSON array and collect unique values.
- runtimes: `SELECT DISTINCT runtime FROM listings WHERE dead_link = 0 AND runtime IS NOT NULL ORDER BY runtime`.

**2. Create `src/app/tools/page.tsx`:**

Async Server Component that reads searchParams and fetches browse results:

```typescript
export default async function BrowsePage({
  searchParams,
}: {
  searchParams: Promise<{
    category?: string;
    chain?: string;
    runtime?: string;
    protocol?: string;
    sort?: string;
    q?: string;
    page?: string;
  }>
}) {
  const params = await searchParams;
  // Parse page number, default 1
  // Calculate offset from page
  // Call browseListings with filters
  // Call getFilterOptions for dropdown values
  // Call countByCategory for category nav
}
```

- Page size: 24 items (constant, not hardcoded — define `const PAGE_SIZE = 24` at top)
- Render: CategoryNav (from Plan 01) at top with active state based on current category filter, FilterPanel (Client Component from Task 2), listing grid using ListingCard (from Plan 01), Pagination (Client Component from Task 2)
- Static metadata: `export const metadata = { title: 'Browse Tools | AI Bazaar', description: '...' }`
- Empty state: If browseResult.listings.length === 0, show "No tools match your filters" with a link to clear all filters (/tools)
- Active category highlight: Pass `activeCategory` prop to CategoryNav (requires updating CategoryNav to accept and use this prop — add optional `activeCategory?: string` prop, apply different styling when category matches)
  </action>
  <verify>
- `bun run build` completes without type errors
- `browseListings` function exists in search.ts and returns `BrowseResult` with total count
- `getFilterOptions` function exists in search.ts
- `/tools` page loads with real listings from database
- URL `/tools?category=mcp-server` filters to MCP Server category only
- URL `/tools?sort=recent` sorts by most recent first
  </verify>
  <done>
Browse page at `/tools` renders paginated listings with server-side data fetching. Category, chain, runtime, and sort filters read from URL searchParams. Total count available for pagination.
  </done>
</task>

<task type="auto">
  <name>Task 2: Filter panel and pagination Client Components</name>
  <files>
    src/components/filter-panel.tsx
    src/components/pagination.tsx
    src/components/category-nav.tsx
  </files>
  <action>
**1. Create `src/components/filter-panel.tsx`:**

Client Component ('use client') for interactive filter controls:

- Import `useRouter`, `useSearchParams`, `usePathname` from 'next/navigation'
- Props: `categories` (array of {category, count, label}), `chains` (string[]), `runtimes` (string[])
- Render filter controls:
  - **Category:** Dropdown/select or button group showing all 6 categories with counts. Pre-select based on current searchParams.category.
  - **Chain:** Dropdown with chain options (ethereum, solana, etc. from getFilterOptions). Pre-select based on current searchParams.chain.
  - **Runtime:** Dropdown with runtime options (node, python, rust, go, other). Pre-select based on current searchParams.runtime.
  - **Protocol:** Dropdown with options: "All", "MCP Compatible", "ACP Compatible". Pre-select based on current searchParams.protocol (empty = All, 'mcp' = MCP Compatible, 'acp' = ACP Compatible).
  - **Sort:** Two-button toggle: "Popular" (default) and "Recent". Highlight active based on searchParams.sort.
  - **Clear all:** Button that navigates to `/tools` (removes all params)
- On any filter change: construct new URLSearchParams from current params, set/delete the changed param, reset page to 1 (delete 'page' param), call `router.push(\`${pathname}?${params.toString()}\`)`.
- Mobile: Stack filters vertically. Show a "Filters" toggle button that expands/collapses the filter panel (use useState for open/close state).
- Desktop: Show all filters in a horizontal row.

**2. Create `src/components/pagination.tsx`:**

Client Component ('use client') for page navigation:

- Props: `currentPage: number`, `totalPages: number`
- Import `usePathname`, `useSearchParams` from 'next/navigation'
- Import `Link` from 'next/link'
- `createPageURL(pageNumber)`: clone current searchParams, set 'page' to pageNumber, return `${pathname}?${params.toString()}`
- Render: Previous link (disabled/hidden on page 1), page number indicators (show current, first, last, and 1-2 neighbors with ellipsis for gaps), Next link (disabled/hidden on last page)
- Use `Link` component for navigation (not router.push) to allow prefetching
- Hide entire component if totalPages <= 1

**3. Update `src/components/category-nav.tsx`:**

Add optional `activeCategory?: string` prop:
- When activeCategory matches a category, apply distinct styling (e.g., bg-blue-600 text-white instead of bg-gray-100 text-gray-700)
- All existing functionality preserved
  </action>
  <verify>
- `bun run build` completes without errors
- FilterPanel renders with category, chain, runtime dropdowns and sort toggle
- Changing a filter updates the URL searchParams (router.push)
- Pagination renders Previous/Next links with correct page URLs
- Pagination preserves existing filter params when changing pages
- CategoryNav highlights the active category when activeCategory prop is passed
  </verify>
  <done>
Filter panel updates URL searchParams on interaction, triggering Server Component re-render with new filtered data. Pagination navigates between pages while preserving filter state in URL. All filter/page state is bookmarkable and shareable.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no type errors
2. `/tools` loads with 24 listings, pagination shows total pages
3. `/tools?category=mcp-server` filters to MCP servers only
4. `/tools?chain=ethereum` filters to Ethereum-supporting tools
5. `/tools?runtime=python` filters to Python tools
6. `/tools?protocol=mcp` filters to MCP-compatible tools only
7. `/tools?protocol=acp` filters to ACP-compatible tools only
8. `/tools?sort=recent` sorts by newest first
9. `/tools?category=ai-agent&sort=recent&protocol=mcp&page=2` combines all params correctly
10. Changing a filter resets to page 1
11. Copy-pasting a filtered URL into a new tab shows the same results
12. Empty state shown when filters match zero results
</verification>

<success_criteria>
- Browse page renders server-side with real data from browseListings service function
- All filter state lives in URL searchParams — no filter state is client-only
- Pagination works with total count, preserves filters across pages
- FilterPanel is the only Client Component — page itself is a Server Component
- URLs are fully shareable and bookmarkable
</success_criteria>

<output>
After completion, create `.planning/phases/03-web-frontend/03-02-SUMMARY.md`
</output>
